angular.module("PlantsApp",["ionic","ui.router","pouchdb"]).directive("plantMainMenu",function(){return{restrict:"E",templateUrl:"app/menus/main.html"}}),function(){angular.module("PlantsApp").config(["$stateProvider","$urlRouterProvider",function(a,b){b.when("","/list"),b.when("/","/list"),b.when("/list","/list/"),a.state("list",{url:"/list/{id}",controller:"PlantListCtrl",templateUrl:"app/components/plant/list.html"}),a.state("detail",{url:"/detail/{id}",controller:"PlantDetailCtrl",templateUrl:"app/components/plant/detail.html"})}])}(),function(){function a(a,b,c,d){var e=b.id;a.getPhotoUrl=d.getPhotoUrl,c.getPlant(e).then(function(b){console.log(b),c.isUnknown(b)?(a.unknown=b,a.plant=b.idPlant):a.plant=b,d.query(b.scientific,function(b){console.log("photo queried",b);var c=d.getPhotos(b);a.photos=c,c.length>0&&(a.thumbnail=d.getPhotoUrl(c[0],d.SMALL),a.caption=c[0].title)})})}angular.module("PlantsApp").controller("PlantDetailCtrl",["$scope","$stateParams","plantList","flickr",a])}(),function(){function a(a,b,c,d){d.isLoading()&&c.show({template:"Initializing Plant List..."}),a.genusSuffix=function(a){return a.code.lastIndexOf("SPP")==a.code.length-3?" spp. (lump)":a.scientific&&a.scientific==a.genus?" sp.":""},a.plantFilter=function(a){return a?(a=a.toLowerCase(),function(b){function c(b){return b&&-1!==b.toLowerCase().indexOf(a)}return c(b.code)||c(b.scientific)||c(b.common)||c(b.idCode)||c(b.idScientific)||c(b.name)?!0:b.synonyms?b.synonyms.some(function(a){return c(a.code)||c(a.scientific)}):!1}):function(){return!0}};var e=b.id||d.ALL_PLANTS;a.listName=d.getListName(e),d.getPlants(e).then(function(b){console.log(b),a.plants=b,c.hide()})}angular.module("PlantsApp").controller("PlantListCtrl",["$scope","$stateParams","$ionicLoading","plantList",a])}(),function(){function a(a,b){var c={THUMB:"t",SMALL:"m",MEDIUM:"z",LARGE:"b",getServiceUrl:function(a){return"https://www.flickr.com/services/rest/?method="+a},query:function(d,e){b.load(function(){var f=c.getServiceUrl("flickr.photos.search")+"&sort=relevance&per_page=10&format=json&text="+d+"&api_key="+b.get("flickr_api_key");return a.jsonp(f+"&jsoncallback=JSON_CALLBACK").success(e)})},getPhotos:function(a){return"ok"!=a.stat?[]:a.photos.photo},getPhotoUrl:function(a,b){return"https://farm"+a.farm+".staticflickr.com/"+a.server+"/"+a.id+"_"+a.secret+"_"+(b||c.THUMB)+".jpg"}};return c}angular.module("PlantsApp").factory("flickr",["$http","config",a])}(),function(){function a(a,b,c){function d(){function d(b,c,d,f){return e.get(b)["catch"](function(b){if(404!==b.status)throw b;return console.log("updating db with "+f),a.get(f).then(function(a){return e.allDocs({startkey:c,endkey:d}).then(function(b){var c={};return angular.forEach(b.rows,function(a){c[a.id]=a.value.rev}),angular.forEach(a.data,function(a){var b=c[a._id];b&&(a._rev=b)}),e.bulkDocs(a.data)})})["catch"](function(a){console.log("Error fetching "+f,a)})})}var e=c("plants");return b.all([d("VIRO3","A","ZZZZ","assets/json/all_plants.json"),d("list-plant:2014 TALL Diversity/TALL_001/Subplot 31/TALL_001 31.1.10:VIRO3","list-plant:2014 TALL Diversity","list-plant:2014 TALL Diversity￿","assets/json/div_lists.json"),d("unk:2015:TALL:603","unk:2015:TALL:","unk:2015:TALL:￿","assets/json/TALL_unknowns.json")]).then(function(){return g=!1,e})}function e(a){return function(){var b=Array.prototype.slice.call(arguments);return f.then(function(c){return a.apply(a,[c].concat(b))})}}var f=d(),g=!0,h={ALL_PLANTS:"All Plants",listMap:{},isLoading:function(){return g},isUnknown:function(a){return"unk"==("object"==typeof a?a._id:a).substr(0,3)},getPlant:e(function(a,b){return a.get(b).then(function(b){return h.isUnknown(b)?a.allDocs({keys:b.synonyms||[],include_docs:!0}).then(function(a){return angular.forEach(a.rows,function(a,c){a.doc&&(b.synonyms[c]=a.doc,!b.idCode&&a.doc.idCode&&(b.idCode=a.doc.idCode))}),b}).then(function(b){return b.idCode?a.get(b.idCode)["catch"](function(){}).then(function(a){return b.idPlant=a,b}):b}):b})}),getListName:function(a){return a==h.ALL_PLANTS?a:a.substr(a.lastIndexOf("/")+1)},getLists:e(function(a){return console.log("getLists start",new Date),a.allDocs({startkey:"A",endkey:"ZZZZ"}).then(function(a){return console.log("getLists got ALL_PLANTS",new Date),[{id:h.ALL_PLANTS,name:h.ALL_PLANTS,parent:null,children:[],count:a.rows.length}]}).then(function(b){return a.allDocs({startkey:"list-plant:",endkey:"list-plant:￿"}).then(function(a){function c(a){for(var b=a.split(":"),c=b[1],e=b[2],f=h.listMap[c]||d(c);f;)f.plantsMap[e]||(f.plantsMap[e]=!0,f.plants.push(e),++f.count),f=f.parent}function d(a){var c=a.match(/(.*)\/([^\/]*)$/),e={id:a,name:c?c[2]:a,parent:c?c[1]:null,children:[],plants:[],plantsMap:{},count:0};if(h.listMap[e.id]=e,e.parent){var f=h.listMap[e.parent]||d(e.parent);e.parent=f,f.children.push(e)}return e.parent||b.push(e),e}return console.log("getLists got list-plants",new Date),h.listMap={},angular.forEach(a.rows,function(a){c(a.key)}),console.log("getLists list-plants done",new Date),b})}).then(function(b){return a.allDocs({startkey:"unk:",endkey:"unk:￿"}).then(function(a){function c(a){var c=a.split(":"),d=c[1],e=c[2],f="Unknowns "+d+" "+e,g="unk:"+d+":"+e,i=h.listMap[g]||{id:g,name:f,parent:null,children:[],plants:[],count:0};h.listMap[i.id]||(h.listMap[i.id]=i,b.push(i)),i.count+=1,i.plants.push(a)}return console.log("getLists got unknowns",new Date),angular.forEach(a.rows,function(a){c(a.key)}),console.log("getLists unknowns done",new Date),b})})}),getPlants:e(function(a,b){function c(a){return a.map(function(a){return a.doc||{code:a.key,scientific:a.key,common:"unknown"}})}var d;return b==h.ALL_PLANTS||void 0===b?(d={startkey:"A",endkey:"Z￿",include_docs:!0},console.log("getPlants: allDocs",d),a.allDocs(d).then(function(a){return console.log("getPlants: result",a),c(a.rows)})):h.listMap[b]?a.allDocs({keys:h.listMap[b].plants,include_docs:!0}).then(function(a){return console.log("getPlants: from computed list",a),c(a.rows)}):(h.isUnknown(b)||(b="list-plant:"+b),d={startkey:b+"/",endkey:b+"/￿"},console.log("getPlants: allDocs",d),a.allDocs(d).then(function(c){return d={startkey:b+":",endkey:b+":￿"},console.log("getPlants: allDocs",d),a.allDocs(d).then(function(a){return c.rows.concat(a.rows)})}).then(function(b){var d=[],e={};return angular.forEach(b,function(a){var b=a.key.split(":"),c=b[2];h.isUnknown(a.key)&&(c=b.join(":")),e[c]||(e[c]=!0,d.push(c))}),a.allDocs({keys:d,include_docs:!0}).then(function(a){return console.log("getPlants: result",a),c(a.rows)})}))})};return h}angular.module("PlantsApp").factory("plantList",["$http","$q","pouchDB",a])}(),function(){function a(a,b){var c={};a.toggleChildren=function(a){c[a.id]=!c[a.id]},a.areChildrenShown=function(a){return c[a.id]},b.getLists().then(function(b){console.log("Lists",b),a.plantLists=b})}angular.module("PlantsApp").controller("MainMenuCtrl",["$scope","plantList",a])}(),function(){function a(a){var b={get:function(b){return a.get("config-"+b)},set:function(b,c){a.set("config-"+b,c)},hasConfig:function(){return null!=b.get("version")},load:function(a){b.hasConfig()?a(b):b.update(a)},update:function(a){a(b)}};return b}angular.module("PlantsApp").factory("config",["storage",a])}(),function(){PouchDB.plugin({putIfNotExists:function(a,b){return this.put(a,b)["catch"](function(b){if(409!=b.status)throw b;return a})},createViewDoc:function(a,b,c){var d={_id:"_design/"+a,views:{}};return d.views[a]={map:b.toString()},c&&(d.views[a].reduce=c.toString()),d},upsertView:function(a,b,c){var d=this,e=d.createViewDoc(a,b,c);return d.get(e._id).then(function(b){return b.views[a].map!=e.views[a].map||b.views[a].reduce!=e.views[a].reduce?(e._rev=b._rev,d.put(e)):b})["catch"](function(a){if(404===a.status)return d.put(e);throw a})}})}(),function(){function a(a){var b={_data:{},get:function(a,c){return b._data[a]||(b._data[a]=JSON.parse(localStorage.getItem(a))||c)},set:function(a,c){b._data[a]=c,localStorage.setItem(a,JSON.stringify(c))},getPromise:function(c,d){return a(function(a){a(b.get(c,d))})}};return b}angular.module("PlantsApp").factory("storage",["$q",a])}(),angular.module("PlantsApp").run(["$templateCache",function(a){"use strict";a.put("app/components/plant/detail.html",'<ion-view><ion-nav-title>{{ unknown.name || plant.scientific }}</ion-nav-title><ion-content><div ng-show=unknown><h2>{{ unknown.name }}</h2><div class=row><div class=col-33>Code</div><div class=col>{{ unknown.code }}{{ unknown.idCode ? \' (\' + unknown.idCode + \')\': \'\'}}</div></div><div class=row><div class=col-33>Collected</div><div class=col>{{ unknown.collectedDate }} {{ unknown.collector }}</div></div><div class=row><div class=col-33>Plot</div><div class=col>{{ unknown.plot }}</div></div><div class=row><div class=col-33>Habitat</div><div class=col>{{ unknown.habitat }}</div></div><div class=row><div class=col-33>Description</div><div class=col>{{ unknown.description }}</div></div><h3 ng-show="unknown.synonyms.length > 0">Synonyms</h3><div class=row ng-repeat="synonym in unknown.synonyms"><a class=col-25 ui-sref=detail({id:synonym._id})>{{ synonym.code }}</a><div class="col scientific">{{ synonym.name }}</div></div></div><div ng-show=plant><h2>{{ plant.scientific }}</h2><h3>{{ plant.common }}</h3><a href="http://plants.usda.gov/core/profile?symbol={{ plant.code }}">USDA</a><div class=plant-detail><div class=row><div class=col>Code</div><div class=col>{{ plant.code }}</div></div><div class=row><div class=col>Family</div><div class=col>{{ plant.family }} ({{ plant.familyCommon }})</div></div><div class=row><div class=col>Growth Form</div><div class=col>{{ plant.growth.join(\', \') }}</div></div></div><h3 ng-show="plant.synonyms.length > 0">Synonyms</h3><div class=row ng-repeat="synonym in plant.synonyms"><div class=col-25>{{ synonym.code }}</div><div class="col scientific">{{ synonym.scientific }}</div></div><div class=plant-thumb><img src="{{ thumbnail }}"><div class=thumb-caption>{{ caption }}</div></div></div></ion-content></ion-view>'),a.put("app/components/plant/list.html",'<ion-view><ion-nav-title>{{ listName }}</ion-nav-title><ion-header-bar align-title=left class="bar-subheader bar-clear item-input-inset"><label class=item-input-wrapper><i class="icon ion-ios-search placeholder-icon"></i> <input type=search placeholder=Search ng-model=searchText> <button class="button ion-android-close button-dark button-clear" ng-show=searchText on-tap="searchText=\'\'"></button></label></ion-header-bar><ion-content><ion-list class=plant-list><ion-item collection-repeat="plant in plants | filter:plantFilter(searchText) | orderBy:\'scientific || code\'" ui-sref=detail({id:plant._id}) ng-class="(plant.idYear || plant.idCode) ? \'id-\' + (plant.idYear || 2015) : \'\'"><div class=col-code><div>{{ plant.code }}</div><div>{{ plant.idCode }}</div></div><div class=col-name><div ng-class="plant.scientific ? \'scientific\' : \'common\'">{{ plant.scientific || plant.name }}{{ genusSuffix(plant) }}</div><div ng-class="plant.scientific ? \'common\' : \'scientific\'">{{ plant.common || plant.idScientific }}</div></div><div class=col-growth><div ng-repeat="form in plant.growth" ng-class="\'growth-\' + form.toLowerCase().split(\'/\')[0]">{{ form == "Fern" ? "Fn" : form[0] }}</div></div></ion-item></ion-list></ion-content></ion-view>'),a.put("app/menus/list_item.html","<ion-item ng-click><a ng-style=\"{'padding-left':(16 * (list.depth = 1 + (list.parent.depth || 0))) +  'px'}\" ng-click=toggleChildren(list)><i class=expand-collapse ng-class=\"areChildrenShown(list) ? 'ion-arrow-down-b' : 'ion-arrow-right-b'\" ng-show=\"list.children.length > 0\"></i></a> <span ui-sref=list({id:list.id}) menu-close>{{ list.name }} ({{ list.count }})</span></ion-item><div ng-show=areChildrenShown(list)><div ng-repeat=\"list in list.children\" ng-include=\"'app/menus/list_item.html'\"></div></div>"),a.put("app/menus/main.html",'<ion-header-bar class="bar bar-header bar-balanced"><h1 class=title>Plant Lists</h1></ion-header-bar><ion-content has-header=true ng-controller=MainMenuCtrl><ion-list><div ng-repeat="list in plantLists" ng-include="\'app/menus/list_item.html\'"></div></ion-list></ion-content>')}]);
//# sourceMappingURL=app.min.js.map