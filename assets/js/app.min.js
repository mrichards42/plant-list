angular.module("PlantsApp",["ionic","ui.router","pouchdb"]).directive("plantMainMenu",function(){return{restrict:"E",templateUrl:"app/menus/main.html"}}).directive("syncButton",function(){return{restrict:"E",templateUrl:"app/components/sync/sync.html"}}),function(){angular.module("PlantsApp").config(["$stateProvider","$urlRouterProvider",function(a,b){b.when("","/list"),b.when("/","/list"),b.when("/list","/list/"),a.state("config",{url:"/config",controller:"ConfigCtrl",templateUrl:"app/components/config/config.html"}),a.state("list",{url:"/list/{id}",controller:"PlantListCtrl",templateUrl:"app/components/plant/list.html"}),a.state("detail",{url:"/detail/{id}",controller:"PlantDetailCtrl",templateUrl:"app/components/plant/detail.html"})}])}(),function(){function a(a,b,c,d,e){function f(){return"https://"+g.database+".cloudant.com/plants"}var g=c.load();a.config=g,a.login=function(){g.database=g.username,d.openRemote({url:f(),username:g.username,password:g.password}).then(function(b){e.sync(b).then(console.log.bind(console))["catch"](console.log.bind(console)),g.saveUsername||(g.username=""),g.password="",g.isLoggedIn=!0,g.save(),a.$apply()})["catch"](function(a){console.log(a),b.alert({title:"Could not log in",template:"Check username and password"})})},a.logout=function(){d.openRemote(f(),{skipSetup:!0}).logout(),g.isLoggedIn=!1,g.save()}}angular.module("PlantsApp").controller("ConfigCtrl",["$scope","$ionicPopup","config","pouchDB","plantList",a])}(),function(){function a(){function a(){try{angular.copy(JSON.parse(localStorage.getItem(b)),this)}catch(a){console.log("config error")}}var b="plants-config";return a.prototype.save=function(){localStorage.setItem(b,JSON.stringify(this))},{load:function(){return new a}}}angular.module("PlantsApp").factory("config",a)}(),function(){function a(a,b,c,d){var e=b.id;a.getPhotoUrl=d.getPhotoUrl,c.getPlant(e).then(function(b){console.log(b),c.isUnknown(b)?(a.unknown=b,a.plant=b.idPlant):a.plant=b,d.query(b.scientific,function(b){console.log("photo queried",b);var c=d.getPhotos(b);a.photos=c,c.length>0&&(a.thumbnail=d.getPhotoUrl(c[0],d.SMALL),a.caption=c[0].title)})})}angular.module("PlantsApp").controller("PlantDetailCtrl",["$scope","$stateParams","plantList","flickr",a])}(),function(){function a(a,b,c){a.genusSuffix=function(a){return a.code.lastIndexOf("SPP")==a.code.length-3?" spp. (lump)":a.scientific&&a.scientific==a.genus?" sp.":""},a.plantFilter=function(a){return a?(a=a.toLowerCase(),function(b){function c(b){return b&&-1!==b.toLowerCase().indexOf(a)}return c(b.code)||c(b.scientific)||c(b.common)||c(b.idCode)||c(b.idScientific)||c(b.name)?!0:b.synonyms?b.synonyms.some(function(a){return c(a.code)||c(a.scientific)}):!1}):function(){return!0}};var d=b.id||c.ALL_PLANTS;a.listName=c.getListName(d),c.getPlants(d).then(function(b){console.log("$scope.plants",b),a.plants=b,console.log("$scope.plants done")})}angular.module("PlantsApp").controller("PlantListCtrl",["$scope","$stateParams","plantList",a])}(),function(){function a(a,b){var c={THUMB:"t",SMALL:"m",MEDIUM:"z",LARGE:"b",getServiceUrl:function(a){return"https://www.flickr.com/services/rest/?method="+a},query:function(d,e){b.load(function(){var f=c.getServiceUrl("flickr.photos.search")+"&sort=relevance&per_page=10&format=json&text="+d+"&api_key="+b.get("flickr_api_key");return a.jsonp(f+"&jsoncallback=JSON_CALLBACK").success(e)})},getPhotos:function(a){return"ok"!=a.stat?[]:a.photos.photo},getPhotoUrl:function(a,b){return"https://farm"+a.farm+".staticflickr.com/"+a.server+"/"+a.id+"_"+a.secret+"_"+(b||c.THUMB)+".jpg"}};return c}angular.module("PlantsApp").factory("flickr",["$http","config",a])}(),function(){function a(a,b,c){function d(a,b){return a="_local/"+a,function(){var c=arguments;return f.get(a)["catch"](function(b){if(404!==b.status)throw b;return{_id:a,update_seq:0}}).then(function(d){return f.info().then(function(e){return d.update_seq===e.update_seq?(console.log("Using memoized data from "+a),d.data):b(c).then(function(b){return f.upsert(a,function(a){return a.data=b,a.update_seq=e.update_seq,a}).then(function(){return console.log("data cached",b),b})})})})["catch"](console.log.bind(console))}}function e(){function a(a,d){function e(a){for(var b=d(a),c=f(b.list);c;)c.plantsMap[b.plant]||(c.plantsMap[b.plant]=!0,c.plants.push(b.plant),++c.count),c=c.parent}function f(a){if(c[a])return c[a];var d=a.match(/(.*)\/([^\/]*)$/),e={id:a,name:d?d[2]:a,parent:d?d[1]:null,children:[],plants:[],plantsMap:{},count:0};if(c[e.id]=e,e.parent){var g=f(e.parent);e.parent=g,g.children.push(e)}return e.parent||b.push(e),e}angular.forEach(a,function(a){e(a.key)})}console.log("buildLists start",new Date);var b=[],c={};return f.allDocs({startkey:"A",endkey:"ZZZZ"}).then(function(a){console.log("buildLists ALL_PLANTS start",new Date),b.push({id:g.ALL_PLANTS,name:g.ALL_PLANTS,parent:null,children:[],count:a.rows.length}),console.log("buildLists ALL_PLANTS end",new Date)}).then(function(){return f.allDocs({startkey:"list-plant:",endkey:"list-plant:￿"}).then(function(b){console.log("getLists list-plants start",new Date),a(b.rows,function(a){var b=a.split(":");return{list:b[1],plant:b[2]}}),console.log("getLists list-plants done",new Date)})}).then(function(){return f.allDocs({startkey:"unk:",endkey:"unk:￿"}).then(function(b){console.log("getLists unknowns start",new Date),a(b.rows,function(a){var b=a.split(":");return{list:["Unknowns",b[1],b[2]].join(" "),plant:a}}),console.log("getLists unknowns done",new Date)})}).then(function(){function a(b){delete b.parent,delete b.listMap,angular.forEach(b.children,a)}return angular.forEach(b,a),{lists:b,map:c}})}var f=b("plants"),g={ALL_PLANTS:"All Plants",isUnknown:function(a){return"unk"==("object"==typeof a?a._id:a).substr(0,3)},getPlant:function(a){return f.get(a).then(function(a){return g.isUnknown(a)?f.allDocs({keys:a.synonyms||[],include_docs:!0}).then(function(b){return angular.forEach(b.rows,function(b,c){b.doc&&(a.synonyms[c]=b.doc,!a.idCode&&b.doc.idCode&&(a.idCode=b.doc.idCode))}),a}).then(function(a){return a.idCode?f.get(a.idCode)["catch"](function(){}).then(function(b){return a.idPlant=b,a}):a}):a})},getListName:function(a){return a==g.ALL_PLANTS?a:a.substr(a.lastIndexOf("/")+1)},getLists:function(){return d("lists",e)().then(function(a){return a.lists.map=a.map,a.lists})},getPlants:function(a){function b(a){return a.map(function(a){return a.doc||{code:a.key,scientific:a.key,common:"unknown"}})}var c;return a==g.ALL_PLANTS||void 0===a?(c={startkey:"A",endkey:"Z￿",include_docs:!0},console.log("getPlants: allDocs",c,new Date),f.allDocs(c).then(function(a){return console.log("getPlants: result",a,new Date),b(a.rows)})):g.getLists().then(function(c){return f.allDocs({keys:c.map[a].plants,include_docs:!0}).then(function(a){return console.log("getPlants: from computed list",a),b(a.rows)})})},sync:function(d){return a.when(d||b.openRemote("plants")).then(function(a){return c(a,f)})}};return g.sync(),g}angular.module("PlantsApp").factory("plantList",["$q","pouchDB","pouchReplicate",a])}(),function(){angular.module("PlantsApp").factory("pouchReplicate",function(){function a(a,g,j){return d("start"),++h,b(g).then(function(c){return b(a).then(function(a){return console.log("Comparing pouchdb-dump revisions"),console.log("source",a,"target",c),a>c})}).then(function(b){return console.log(b?"Using pouchdb-dump":"Skipping pouchdb-dump"),b?a.get("_local/dump").then(function(b){return g.load(b.dump,{proxy:a.getUrl()}).then(function(){return c(g,b._rev)})}).then(function(){return g.info().then(function(a){e({ok:!0,docs_read:a.doc_count,docs_written:a.doc_count})})}):void 0}).then(function(){console.log("Starting replication");var b=PouchDB.replicate(a,g,j);return b.on("complete",function(a){e(a),f()}).on("error",function(a){i.push(a),f()}),b})["catch"](function(a){console.log(a)})}function b(a){return a.get("_local/dump-info").then(function(a){return a.latest_rev})["catch"](function(a){if(404!==a.status)throw a;return"0"})}function c(a,b){return a.upsert("_local/dump-info",function(a){return a.latest_rev=b,a})}function d(a){var b=Array.prototype.slice.call(arguments,1);angular.forEach(g[a],function(a){a.apply(null,b)})}function e(a){j.ok=(void 0===j.ok?!0:j.ok)&&(void 0===a.ok?!0:a.ok),j.errors=(j.errors||[]).concat(a.errors||[]),j.last_seq=a.last_seq||0,angular.forEach(["doc_write_failures","docs_read","docs_written"],function(b){j[b]=(j[b]||0)+(a[b]||0)})}function f(){--h,0>=h&&(i.length>0?d("error",i):d("complete",j),i=[],j={})}a.on=function(b,c){return g[b]&&g[b].push(c),a};var g={complete:[],error:[],start:[]},h=0,i=[],j={};return a})}(),function(){function a(a,b,c,d,e,f){a.isSyncing=!1,a.sync=function(){e.sync()["catch"](function(a){if("authentication_error"!==a.name)throw a;c.confirm({title:"Sync error",template:"Please login to sync plants database",okText:"Login"}).then(function(){b.go("config")})})},f.on("start",function(){a.isSyncing=!0}).on("complete",function(b){a.isSyncing=!1,b.docs_written&&b.docs_read&&d.show("Updated "+b.docs_written+" of "+b.docs_read+" docs")}).on("error",function(){a.isSyncing=!1,d.show("Errors during sync")})}angular.module("PlantsApp").controller("SyncCtrl",["$scope","$state","$ionicPopup","toast","plantList","pouchReplicate",a])}(),function(){function a(a,b){var c={};a.toggleChildren=function(a){c[a.id]=!c[a.id]},a.areChildrenShown=function(a){return c[a.id]},b.getLists().then(function(b){console.log("Lists",b),a.plantLists=b})}angular.module("PlantsApp").controller("MainMenuCtrl",["$scope","plantList",a])}(),function(){angular.module("pouchdb").run(["$q","pouchDB",function(a,b){function c(a,b){var c=a.getHost(a.getUrl());return c.protocol+"://"+c.host+"/"+(b||"")}function d(a){return a.getUrl().match(/\.cloudant\.com/)}function e(a){return a.getHost(a.getUrl())}function f(a){return JSON.parse(localStorage.getItem(k+e(a).host))}function g(a,b){var c=k+e(a).host;b?localStorage.setItem(c,JSON.stringify(b)):localStorage.removeItem(c)}function h(a,b){return a.login(b[0],b[1]).then(function(c){return b[2]=a.getHost(a.getUrl()).host,g(a,b),console.log("successfully logged in with token",b),c})}PouchDB.plugin({createViewDoc:function(a,b,c){var d={_id:"_design/"+a,views:{}};return d.views[a]={map:b.toString()},c&&(d.views[a].reduce=c.toString()),d},openDB:function(a){return new PouchDB(a?c(this,a):this.getUrl())}}),PouchDB.plugin({getSecurity:function(){return this.request({url:"_security"})},putSecurity:function(a){return this.request({url:"_security",body:a,method:"PUT"})}});var i=PouchDB.prototype.login,j=PouchDB.prototype.signup;PouchDB.plugin({login:function(a,b,c,e){c=c||{},d(this)&&(c.ajax=angular.extend({headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"name="+encodeURIComponent(a)+"&password="+encodeURIComponent(b)},c.ajax||{}));var f=[a,b,c];return e&&f.push(e),i.apply(this,f)},signup:function(a,b,c,e){if(c=c||{},c.roles=c.roles||["user"],d(this)){var f=PouchDB.utils.uuid(),g=CryptoJS.SHA1(b+f).toString();c.metadata=c.metadata||{},c.metadata.password_sha=g,c.metadata.salt=f,c.metadata.password_scheme="simple",c.metadata.password="",c.metadata.useragent=navigator.userAgent,c.metadata.created=(new Date).toString()}var h=[a,b,c];return e&&h.push(e),j.apply(this,h)},setupSecurity:function(b,d){var e=this;b=b||[e.getHost(e.getUrl()).db],d=d||{couchdb_auth_only:!0,members:{names:[],roles:["user"]},admins:{}};new PouchDB(c(e,"_users"));return a.all(b.map(function(a){return e.openDB(a).putSecurity(d)}))},tokenLogin:function(a,b){var c=this,d=f(c)||[];return h(c,d)["catch"](function(d){if(403!==d.status&&400!==d.status)throw d;if(!a||!b)throw d;return c.login(a,b).then(function(a){console.log(a);var b=[PouchDB.utils.uuid(),PouchDB.utils.uuid()];return c.signup(b[0],b[1]).then(function(){return h(c,b)})})})}});var k="plantlist-token:",l="plantlist-remote:";b.openRemote=function(c,d){"object"==typeof c?d=c:(d=d||{},-1!==c.indexOf("://")?d.url=c:d.name=c);var f=d.url||localStorage.getItem(l+d.name);if(!f)return a.reject({status:400,name:"bad_request",reason:"Missing/invalid DB name",error:!0});var g=b(f,{skipSetup:!0});return d.skipSetup?g:g.tokenLogin(d.username,d.password).then(function(){return localStorage.setItem(l+(d.name||e(g).db),g.getUrl()),g})}}])}(),function(){function a(a){var b={_data:{},get:function(a,c){return b._data[a]||(b._data[a]=JSON.parse(localStorage.getItem(a))||c)},set:function(a,c){b._data[a]=c,localStorage.setItem(a,JSON.stringify(c))},getPromise:function(c,d){return a(function(a){a(b.get(c,d))})}};return b}angular.module("PlantsApp").factory("storage",["$q",a])}(),function(){angular.module("PlantsApp").factory("toast",["$ionicLoading",function(a){return{show:function(b){"string"==typeof b&&(b={message:b});var c=b.message||"";return a.show(angular.extend(b,{noBackdrop:!0,duration:2e3,template:c}))},hide:a.hide}}])}(),angular.module("PlantsApp").run(["$templateCache",function(a){"use strict";a.put("app/components/config/config.html",'<ion-view view-title=Config><ion-content><div ng-hide=config.isLoggedIn><form name=loginForm ng-submit=login()><div class=list><label class="item item-input"><input type=text ng-model=config.username placeholder=Username required></label><label class="item item-input"><input type=password ng-model=config.password placeholder=Password required></label><ion-checkbox class="item item-input" ng-model=config.saveUsername>Save Username</ion-checkbox></div></form></div><div><div ng-show=config.isLoggedIn class=padding>Signed in as <strong>{{ config.username }}</strong> <button class="button button-block button-positive" ng-click=logout()>Sign Out</button></div><div ng-hide=config.isLoggedIn class=padding><button class="button button-block button-positive" ng-click=login() ng-disabled=loginForm.$invalid>Sign In</button></div></div></ion-content></ion-view>'),a.put("app/components/plant/detail.html",'<ion-view><ion-nav-title>{{ unknown.name || plant.scientific }}</ion-nav-title><ion-content><div ng-show=unknown><h2>{{ unknown.name }}</h2><div class=row><div class=col-33>Code</div><div class=col>{{ unknown.code }}{{ unknown.idCode ? \' (\' + unknown.idCode + \')\': \'\'}}</div></div><div class=row><div class=col-33>Collected</div><div class=col>{{ unknown.collectedDate }} {{ unknown.collector }}</div></div><div class=row><div class=col-33>Plot</div><div class=col>{{ unknown.plot }}</div></div><div class=row><div class=col-33>Habitat</div><div class=col>{{ unknown.habitat }}</div></div><div class=row><div class=col-33>Description</div><div class=col>{{ unknown.description }}</div></div><h3 ng-show="unknown.synonyms.length > 0">Synonyms</h3><div class=row ng-repeat="synonym in unknown.synonyms"><a class=col-25 ui-sref=detail({id:synonym._id})>{{ synonym.code }}</a><div class="col scientific">{{ synonym.name }}</div></div></div><div ng-show=plant><h2>{{ plant.scientific }}</h2><h3>{{ plant.common }}</h3><a href="http://plants.usda.gov/core/profile?symbol={{ plant.code }}">USDA</a><div class=plant-detail><div class=row><div class=col>Code</div><div class=col>{{ plant.code }}</div></div><div class=row><div class=col>Family</div><div class=col>{{ plant.family }} ({{ plant.familyCommon }})</div></div><div class=row><div class=col>Growth Form</div><div class=col>{{ plant.growth.join(\', \') }}</div></div></div><h3 ng-show="plant.synonyms.length > 0">Synonyms</h3><div class=row ng-repeat="synonym in plant.synonyms"><div class=col-25>{{ synonym.code }}</div><div class="col scientific">{{ synonym.scientific }}</div></div><div class=plant-thumb><img src="{{ thumbnail }}"><div class=thumb-caption>{{ caption }}</div></div></div></ion-content></ion-view>'),a.put("app/components/plant/list.html",'<ion-view><ion-nav-title>{{ listName }}</ion-nav-title><ion-header-bar align-title=left class="bar-subheader bar-clear item-input-inset"><label class=item-input-wrapper><i class="icon ion-ios-search placeholder-icon"></i> <input type=search placeholder=Search ng-model=searchText> <button class="button ion-android-close button-dark button-clear" ng-show=searchText on-tap="searchText=\'\'"></button></label></ion-header-bar><ion-content><ion-list class=plant-list><ion-item collection-repeat="plant in plants | filter:plantFilter(searchText) | orderBy:\'scientific || code\'" ui-sref=detail({id:plant._id}) ng-class="(plant.idYear || plant.idCode) ? \'id-\' + (plant.idYear || 2015) : \'\'"><div class=col-code><div>{{ plant.code }}</div><div>{{ plant.idCode }}</div></div><div class=col-name><div ng-class="plant.scientific ? \'scientific\' : \'common\'">{{ plant.scientific || plant.name }}{{ genusSuffix(plant) }}</div><div ng-class="plant.scientific ? \'common\' : \'scientific\'">{{ plant.common || plant.idScientific }}</div></div><div class=col-growth><div ng-repeat="form in plant.growth" ng-class="\'growth-\' + form.toLowerCase().split(\'/\')[0]">{{ form == "Fern" ? "Fn" : form[0] }}</div></div></ion-item></ion-list></ion-content></ion-view>'),a.put("app/components/sync/sync.html","<button ng-controller=SyncCtrl class=\"button button-icon icon\" ng-class=\"isSyncing ? '' : 'ion-android-sync'\" ng-click=sync()><ion-spinner icon=bubbles class=spinner-light ng-show=isSyncing></ion-spinner></button>"),a.put("app/menus/list_item.html","<ion-item ng-click><a ng-style=\"{'padding-left':(16 * (list.depth = 1 + (list.parent.depth || 0))) +  'px'}\" ng-click=toggleChildren(list)><i class=expand-collapse ng-class=\"areChildrenShown(list) ? 'ion-arrow-down-b' : 'ion-arrow-right-b'\" ng-show=\"list.children.length > 0\"></i></a> <span ui-sref=list({id:list.id}) menu-close>{{ list.name }} ({{ list.count }})</span></ion-item><div ng-show=areChildrenShown(list)><div ng-repeat=\"list in list.children\" ng-include=\"'app/menus/list_item.html'\"></div></div>"),a.put("app/menus/main.html",'<ion-header-bar class="bar bar-header bar-balanced"><h1 class=title>Plant Lists</h1></ion-header-bar><ion-content has-header=true ng-controller=MainMenuCtrl><ion-list><div ng-repeat="list in plantLists" ng-include="\'app/menus/list_item.html\'"></div></ion-list></ion-content>')}]);
//# sourceMappingURL=app.min.js.map